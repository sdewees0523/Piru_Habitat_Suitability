---
title: "Piru Progress"
author: "Shane Dewees"
date: "12/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(lubridate)
library(sf)
library(raster)
library(tidyverse)
library(stats)
library(jtools)
library(ggparty)
library(partykit)
library(ggfortify)
```

```{r}
planting <- read.csv(here("data", "planting.csv")) %>% 
  rename("plot_number" = "ID")
watering <- read.csv(here("data","watering.csv"))%>% 
  rename("plot_number" = "ID")
measuring <- read.csv(here("data", "measuring.csv"))%>% 
  rename("plot_number" = "ID")
measuring_2 <- read.csv(here("data", "measuring_2.csv"))%>% 
  rename("plot_number" = "ID")
measuring_3 <- read.csv(here("data", "measuring_3.csv"))%>% 
  rename("plot_number" = "ID")

# Table of only plants alive by March 2020
planting_survival <- planting %>% 
  dplyr::select(plot_number, Plant, Height, Date.Planted) %>% 
  mutate(Plant = str_replace_all(string = Plant, pattern = "(White + Pink)", replacement = "")) %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI",
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "RHOV SAAP (White + Pink)" ~ "SAAP",
                           Plant == "ENCA CEOL (Pink)" ~ "CEOL", 
                           Plant == "HEWH (White) RHOV" ~ "RHOV",
                           Plant == "NO PLANT" ~ "No Plant")) %>% 
  filter(Plant != "No Plant", Height != "") %>% 
  mutate(date = my(0320),
         alive = 1) %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Table of plant survival as of May 2020
watering_survival <- watering %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI",
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SANI (Orange + Yellow) CEOL" ~ "CEOL",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "SANI  MALA" ~ "MALA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "HEWH (White) ENCA" ~ "ENCA",
                           Plant == "ADFA" ~ "ADFA",
                           Plant == "SANI" ~ "SANI",
                           Plant == "SAME" ~ "SAME",
                           Plant == "SANI " ~ "SANI",
                           Plant == "" ~"No plant")) %>% 
  filter(Plant != "No plant") %>% 
  mutate(alive = case_when(Alive.1 == "y" ~ 1,
                           Alive.1 == "Y" ~ 1,
                           Alive.1 == "n" ~ 0,
                           Alive.1 == "np" ~ 0,
                           Alive.1 == "" ~ 0,
                           Alive.1 == "N" ~ 0,
                           Alive.1 == "NP" ~ 0),
         date = my(0520)) %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Table of plant survival as of July 2020
measuring_survival <- measuring %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI", 
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ENCA CEOL (Pink)" ~ "CEOL",
                           Plant == "NO PLANT" ~ "No Plant",
                           Plant == "HEWH (White) RHOV" ~ "RHOV",
                           Plant == "HEWH" ~ "HEWH"),
         alive = case_when(Height > 0 ~ 1),
         date = my(0720)) %>% 
  filter(Plant != "No Plant") %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Table of plant survival as of November 2020
measuring_survival_2 <- measuring_2 %>% 
  mutate(Plant = str_replace(Plant, " ", ""),
         alive = case_when(Height > 0 ~ 1,
                           TRUE ~ 0),
         date = my(1120)) %>% 
  filter(Plant != "") %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Table of plant survival as of December 2021
measuring_survival_3 <- measuring_3 %>% 
  mutate(alive = case_when(Height > 0 ~ 1),
        date = my(1221)) %>% 
  filter(Plant != "") %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Table of percent each species alive at all dates
survival <- rbind(planting_survival,watering_survival,measuring_survival, measuring_survival_2, measuring_survival_3) %>% 
  group_by(Plant, date) %>% 
  summarise(alive = sum(alive, na.rm = TRUE)) %>% 
  mutate(alive_percent = case_when(Plant == "ADFA" ~ alive/148 * 100,
                                   Plant == "CEOL" ~ alive/250 * 100,
                                   Plant == "ENCA" ~ alive/204 * 100,
                                   Plant == "HEAR" ~ alive/121 * 100,
                                   Plant == "HEWH" ~ alive/247 * 100,
                                   Plant == "MALA" ~ alive/89 * 100,
                                   Plant == "RHOV" ~ alive/195 * 100,
                                   Plant == "SAAP" ~ alive/95 * 100,
                                   Plant == "SAME" ~ alive/130 * 100, 
                                   Plant == "SANI" ~ alive/160 * 100),
         Plant = case_when(Plant == "ADFA" ~ "Adenostoma fasciculatum",
                                   Plant == "CEOL" ~ "Ceanothus oliganthus",
                                   Plant == "ENCA" ~ "Encelia californica",
                                   Plant == "HEAR" ~ "Heteromeles arbutifolia",
                                   Plant == "HEWH" ~ "Hesperoyucca whipplei",
                                   Plant == "MALA" ~ "Malosma laurina",
                                   Plant == "RHOV" ~ "Rhus ovata",
                                   Plant == "SAAP" ~ "Salvia apiana",
                                   Plant == "SAME" ~ "Salvia mellifera", 
                                   Plant == "SANI" ~ "Sambucus nigra"))

# Table of percent alive for all species combined
survival_total <- survival %>% 
  group_by(date) %>% 
  summarise(alive = sum(alive))

ggplot(survival, aes(date, alive_percent)) +
  geom_point() +
  geom_line () +
  facet_wrap(~Plant, nrow = 5, ncol = 2) +
  labs(y = "Percent Alive") +
  theme_classic()

ggplot(survival, aes(date, alive)) +
  geom_point() +
  geom_line () +
  facet_wrap(~Plant, nrow = 5, ncol = 2) +
  theme_classic()

ggplot(survival_total, aes(date, alive)) +
  geom_point() +
  geom_line() +
  labs(y = "Number plants alive") +
  theme_classic()
  
```

## Cleaning and initial visualization of growth data

```{r}
# Growth data as of March 2020
planting_growth <- planting %>% 
  mutate(Plant = str_replace_all(string = Plant, pattern = "(White + Pink)", replacement = "")) %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI",
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "RHOV SAAP (White + Pink)" ~ "SAAP",
                           Plant == "ENCA CEOL (Pink)" ~ "CEOL", 
                           Plant == "HEWH (White) RHOV" ~ "RHOV",
                           Plant == "NO PLANT" ~ "No Plant")) %>% 
  filter(Plant != "No Plant", Height != "") %>% 
  mutate(date = my(0320)) %>% 
  dplyr::select(plot_number,Plant, Height, Width.1, Width.2, Stem.Diameter, date)

# Growth data as of July 2020
measuring_growth <- measuring %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI", 
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ENCA CEOL (Pink)" ~ "CEOL",
                           Plant == "NO PLANT" ~ "No Plant",
                           Plant == "HEWH (White) RHOV" ~ "RHOV",
                           Plant == "HEWH" ~ "HEWH"),
         date = my(0720)) %>% 
  filter(Plant != "No Plant") %>% 
  dplyr::select(plot_number,Plant, Height, Width.1, Width.2, Stem.Diameter, date)

# Growth data as of November 2020
measuring_growth_2 <- measuring_2 %>% 
  mutate(Plant = str_replace(Plant, " ", ""),
         date = my(1120)) %>% 
  filter(Plant != "") %>% 
  dplyr::select(plot_number,Plant, Height, Width.1, Width.2, Stem.Diameter, date)

# Growth data as of December 2021
measuring_growth_3 <- measuring_3 %>% 
  mutate(date = my(1221)) %>% 
  filter(Plant != "") %>% 
  dplyr::select(plot_number,Plant, Height, Width.1, Width.2, Stem.Diameter, date)

# Growth data grouped by species for all dates
growth <- rbind(planting_growth, measuring_growth, measuring_growth_2, measuring_growth_3) %>% 
  mutate(Height = as.numeric(Height),
         Width.1 = as.numeric(Width.1),
         Width.2 = as.numeric(Width.2),
         Stem.Diameter = as.numeric(Stem.Diameter)) %>% 
  group_by(Plant, date) %>% 
  summarise(mean_height = mean(Height, na.rm = TRUE),
            sd_height = sd(Height, na.rm = TRUE),
            mean_width_1 = mean(Width.1, na.rm = TRUE),
            sd_width_1 = sd(Width.1, na.rm = TRUE),
            mean_width_2 = mean(Width.2, na.rm = TRUE),
            sd_width_2 = sd(Width.2, na.rm = TRUE),
            mean_stem = mean(Stem.Diameter, na.rm = TRUE),
            sd_stem = sd(Stem.Diameter, na.rm = TRUE))

ggplot(growth, aes(date, mean_height)) + 
  geom_point()+
  geom_errorbar(aes(ymin = mean_height - sd_height, ymax = mean_height + sd_height), width = 0.2) +
  geom_line()+
  labs(y = "Stem Height (cm)") +
  facet_wrap(~Plant, nrow = 5, ncol = 2) +
  theme_classic()

ggplot(growth, aes(date, mean_width_1)) + 
  geom_point()+
  geom_errorbar(aes(ymin = mean_width_1 - sd_width_1, ymax = mean_width_1 + sd_width_1), width = 0.2) +
  geom_line()+
  labs(y = "Plant Width (cm)") +
  facet_wrap(~Plant, nrow = 5, ncol = 2) +
  theme_classic()

ggplot(growth, aes(date, mean_stem)) + 
  geom_point()+
  geom_errorbar(aes(ymin = mean_stem - sd_stem, ymax = mean_stem + sd_stem), width = 0.2) +
  geom_line()+
  labs(y = "Stem Diameter (cm)") +
  facet_wrap(~Plant, nrow = 5, ncol = 2) +
  theme_classic()
```

## Looking at survival without gopher kill 
  - unintuitably labelled gopher

```{r}
# Survival in May 2020
watering_gopher <- watering %>% 
  dplyr::select(plot_number, Watering.2.Date, Alive.1, Notes.1) %>% 
  rename("watering_date" = "Watering.2.Date",
         "watering_alive" = "Alive.1", 
         "watering_notes" = "Notes.1") 

# Growth & survival by July 2020 (gophers incl.)
measuring_gopher <- measuring %>% 
  dplyr::select(!Plant) %>% 
  rename("measuring_height" = "Height",
         "measuring_width_1" = "Width.1",
         "measuring_width_2" = "Width.2",
         "measuring_stem_diameter" = "Stem.Diameter",
         "measuring_date" = "Date.Measured",
         "measuring_notes" = "Notes")

# Growth & survival by November 2020 (gophers incl.)
measuring_gopher_2 <- measuring_2 %>% 
  dplyr::select(!Plant) %>%
  rename("measuring_2_height" = "Height",
         "measuring_2_width_1" = "Width.1",
         "measuring_2_width_2" = "Width.2",
         "measuring_2_stem_diameter" = "Stem.Diameter",
         "measuring_2_date" = "Date.Measured",
         "measuring_2_notes" = "Notes")

# Growth & survival by December 2021 (gophers incl.)
measuring_gopher_3 <- measuring_3 %>% 
  dplyr::select(!Plant) %>%
  rename("measuring_3_height" = "Height",
         "measuring_3_width_1" = "Width.1",
         "measuring_3_width_2" = "Width.2",
         "measuring_3_stem_diameter" = "Stem.Diameter",
         "measuring_3_date" = "Date.Measured",
         "measuring_3_notes" = "Notes")

# Joined table of growth/survival with all dates, gophers excluded
survival_gopher <- right_join(planting, watering_gopher, by = "plot_number") %>% 
  right_join(measuring_gopher, by = "plot_number") %>% 
  right_join(measuring_gopher_2, by = "plot_number") %>% 
  right_join(measuring_gopher_3, by = "plot_number") %>%  
  filter(watering_notes != "gopher", 
         watering_notes != "gopher activity", 
         watering_notes != "GOPHER", 
         watering_notes != "GOPHER ACTIVITY", 
         watering_notes != "5/15 np") %>% 
  filter(measuring_notes != "np", 
         measuring_notes != "np, g", 
         measuring_notes != "np, buried", 
         measuring_notes != "g.a.",
         measuring_notes != "dead, g.a.", 
         measuring_notes != "np, g.a.", 
         measuring_notes != "dead, g", 
         measuring_notes != "np, g (no coin catch#2)", 
         measuring_notes != "np,g",
         measuring_notes!= "herbivorized, g.a.") %>% 
  filter(measuring_2_notes != "NP", 
         measuring_2_notes != "MISSING", 
         measuring_2_notes != "NP ", 
         measuring_2_notes != "GOPHER", 
         measuring_2_notes != "NP? NO TAG", 
         measuring_2_notes != "MISSNG") %>%
  filter(measuring_3_notes != "NP")

# Survival data as of March 2020, excl. gopher
planting_survival_gopher <- survival_gopher %>% 
  dplyr::select(plot_number,Plant, Height, Date.Planted) %>% 
  mutate(Plant = str_replace_all(string = Plant, pattern = "(White + Pink)", replacement = "")) %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI",
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "RHOV SAAP (White + Pink)" ~ "SAAP",
                           Plant == "ENCA CEOL (Pink)" ~ "CEOL", 
                           Plant == "HEWH (White) RHOV" ~ "RHOV",
                           Plant == "NO PLANT" ~ "No Plant")) %>% 
  filter(Plant != "No Plant", Height != "") %>% 
  mutate(date = my(0320),
         alive = 1) %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Surival as of May 2020, excl. gopher
watering_survival_gopher <- survival_gopher %>%
  dplyr::select(plot_number,Plant, watering_alive, watering_date) %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI",
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SANI (Orange + Yellow) CEOL" ~ "CEOL",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "SANI  MALA" ~ "MALA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "HEWH (White) ENCA" ~ "ENCA",
                           Plant == "ADFA" ~ "ADFA",
                           Plant == "SANI" ~ "SANI",
                           Plant == "SAME" ~ "SAME",
                           Plant == "SANI " ~ "SANI",
                           Plant == "" ~"No plant")) %>% 
  filter(Plant != "No plant") %>% 
  mutate(alive = case_when(watering_alive == "y" ~ 1,
                           watering_alive == "Y" ~ 1,
                           watering_alive == "n" ~ 0,
                           watering_alive == "np" ~ 0,
                           watering_alive == "" ~ 0,
                           watering_alive == "N" ~ 0,
                           watering_alive == "NP" ~ 0),
         date = my(0520)) %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Survival as of July 2020, excl. gopher
measuring_survival_gopher <- survival_gopher %>% 
  dplyr::select(plot_number,Plant, measuring_height, measuring_date) %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI", 
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ENCA CEOL (Pink)" ~ "CEOL",
                           Plant == "NO PLANT" ~ "No Plant",
                           Plant == "HEWH (White) RHOV" ~ "RHOV",
                           Plant == "HEWH" ~ "HEWH"),
         alive = case_when(measuring_height > 0 ~ 1, 
                           TRUE ~0),
         date = my(0720)) %>% 
  filter(Plant != "No Plant") %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Survival as of November 2020
measuring_survival_gopher_2 <- survival_gopher %>% 
  dplyr::select(plot_number,Plant, measuring_2_height, measuring_2_date) %>% 
  mutate(Plant = str_replace(Plant, " ", ""),
         Plant = case_when(Plant == "ENCA(Pink)" ~ "ENCA",
                           Plant == "CEOL(Orange)" ~ "CEOL",
                           Plant == "HEWH(White)" ~ "HEWH",
                           Plant == "SAME(Orange + Pink)" ~ "SAME",
                           Plant == "SANI(Orange + Yellow)" ~ "SANI", 
                           Plant == "RHOV(White + Pink)" ~ "RHOV",
                           Plant == "SAAP(White + Green)" ~ "SAAP",
                           Plant == "MALA(White + Yellow)" ~ "MALA",
                           Plant == "ADFA(Orange + Green)" ~ "ADFA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ENCACEOL (Pink)" ~ "CEOL",
                           Plant == "NOPLANT" ~ "No Plant",
                           Plant == "HEWH(White) RHOV" ~ "RHOV",
                           Plant == "HEWH" ~ "HEWH",
                           TRUE ~ Plant),
         alive = case_when(measuring_2_height > 0 ~ 1,
                           TRUE ~ 0),
         date = my(1120)) %>% 
  filter(Plant != "") %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Survival as of December 2021, excl. gopher
measuring_survival_gopher_3 <- survival_gopher %>% 
  dplyr::select(plot_number,Plant, measuring_3_height, measuring_3_date) %>% 
  mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI", 
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ENCA CEOL (Pink)" ~ "CEOL",
                           Plant == "NO PLANT" ~ "No Plant",
                           Plant == "HEWH (White) RHOV" ~ "RHOV",
                           Plant == "HEWH" ~ "HEWH"),
         alive = case_when(measuring_3_height > 0 ~ 1, 
                           TRUE ~ 0),
        date = my(1221)) %>% 
  filter(Plant != "") %>% 
  dplyr::select(plot_number,Plant, alive, date)

# Survival grouped by species with all dates, excl. gopher, with pretty field names
survival_gopher_clean <- rbind(planting_survival_gopher,
                  watering_survival_gopher,
                  measuring_survival_gopher, 
                  measuring_survival_gopher_2, 
                  measuring_survival_gopher_3) %>% 
  group_by(Plant, date) %>% 
  summarise(alive = sum(alive, na.rm = TRUE)) %>% 
  ungroup() %>% 
  filter(Plant != "No Plant") %>% 
  mutate(alive_percent = case_when(Plant == "ADFA" ~ alive/118 * 100,
                                   Plant == "CEOL" ~ alive/97 * 100,
                                   Plant == "ENCA" ~ alive/83 * 100,
                                   Plant == "HEAR" ~ alive/61 * 100,
                                   Plant == "HEWH" ~ alive/80 * 100,
                                   Plant == "MALA" ~ alive/43 * 100,
                                   Plant == "RHOV" ~ alive/75 * 100,
                                   Plant == "SAAP" ~ alive/45 * 100,
                                   Plant == "SAME" ~ alive/48 * 100, 
                                   Plant == "SANI" ~ alive/62 * 100),
         Plant = case_when(Plant == "ADFA" ~ "Adenostoma fasciculatum",
                                   Plant == "CEOL" ~ "Ceanothus oliganthus",
                                   Plant == "ENCA" ~ "Encelia californica",
                                   Plant == "HEAR" ~ "Heteromeles arbutifolia",
                                   Plant == "HEWH" ~ "Hesperoyucca whipplei",
                                   Plant == "MALA" ~ "Malosma laurina",
                                   Plant == "RHOV" ~ "Rhus ovata",
                                   Plant == "SAAP" ~ "Salvia apiana",
                                   Plant == "SAME" ~ "Salvia mellifera", 
                                   Plant == "SANI" ~ "Sambucus nigra"))

# Survival of all species combined with all dates, excl. gopher, with pretty field names
survival_gopher_total <- survival_gopher_clean %>% 
  group_by(date) %>% 
  summarise(alive = sum(alive))

ggplot(survival_gopher_clean, aes(date, alive_percent)) +
  geom_point() +
  geom_line () +
  facet_wrap(~Plant, nrow = 5, ncol = 2) +
  labs(y = "Percent Alive") +
  theme_classic()

ggplot(survival, aes(date, alive)) +
  geom_point() +
  geom_line () +
  facet_wrap(~Plant, nrow = 5, ncol = 2) +
  theme_classic()

ggplot(survival_total, aes(date, alive)) +
  geom_point() +
  geom_line() +
  labs(y = "Number plants alive") +
  theme_classic()
```

```{r}
ceanothus <- survival %>% 
  filter(Plant == "Ceanothus oliganthus")

rhus <- survival %>% 
  filter(Plant == "Rhus ovata")

toyon <- survival %>% 
  filter(Plant == "Heteromeles arbutifolia")

ggplot(ceanothus, aes(date, alive_percent, label = date)) +
  geom_point()+
  geom_line() + 
  geom_label(nudge_x = 8, size = 4)+
  labs(x = "date",
       y = "alive percent (%)",
       title = "Ceanothus oliganthus survival") +
  theme_classic()

ggplot(rhus, aes(date, alive_percent, label = date)) +
  geom_point()+
  geom_line() + 
  geom_label(nudge_x = 8, size = 4)+
  labs(x = "date",
       y = "alive percent (%)",
       title = "Rhus ovata survival") +
  theme_classic()

ggplot(toyon, aes(date, alive_percent, label = date)) +
  geom_point()+
  geom_line() + 
  geom_label(nudge_x = 8, size = 4)+
  labs(x = "date",
       y = "alive percent (%)",
       title = "Heteromeles arbutifolia survival") +
  theme_classic()
```


## Reading in gps points and topgraphy data


```{r}
plots <- st_read(here("data", "plot_gps_points.shp")) %>% 
  rename("plot_number" = "plt_nmb")
elevation <- raster(here("data", "elevation.tif"))
aspect <- raster(here("data", "aspect.tif"))
aspect <- cos((aspect * pi/180) - (225 * pi/180))
slope <- raster(here("data", "slope.tif"))
solar_radiation <- brick(here("data", "sol_rad.tif"))
diurnal_heat <- raster(here("data", "diurnal_heat.tif"))
heat_load <- raster(here("data", "heat_load_index.tif"))
ruggedness_vector <- raster(here("data", "ruggedness_vector.tif"))
sol_rad_aspect <- raster(here("data", "sol_rad_aspect.tif"))
terrain_ruggedness <- raster(here("data", "terrain_ruggedness.tif"))
terrain_texture <- raster(here("data", "terrain_texture.tif"))
topographic_position <- raster(here("data", "topographic_position.tif"))

```


## Extracting topographic data to plot points

```{r}
plots_topography <- plots %>% 
  mutate(elevation = raster::extract(elevation, plots),
         aspect = raster::extract(aspect, plots),
         slope = raster::extract(slope, plots),
         summer_solar_radiation = raster::extract(solar_radiation[[3]], plots),
         spring_solar_radiation = raster::extract(solar_radiation[[2]], plots),
         winter_solar_radiation = raster::extract(solar_radiation[[1]], plots),
         diurnal_heat = raster::extract(diurnal_heat, plots),
         heat_load = raster::extract(heat_load, plots),
         sol_rad_aspect = raster::extract(sol_rad_aspect, plots),
         terrain_ruggedness = raster::extract(terrain_ruggedness, plots),
         terrain_texture = raster::extract(terrain_texture, plots),
         topographic_position = raster::extract(topographic_position, plots)) 
```

## Making shapefiles of survival data for mapping

```{r}
planting_survival_spatial <- right_join(planting_survival, plots_topography, by = "plot_number") %>% 
  drop_na(Plant)
may_survival_spatial <- right_join(watering_survival, plots_topography, by = "plot_number") %>% 
  drop_na(Plant)
july_survival_spatial <- right_join(measuring_survival, plots_topography, by = "plot_number") %>% 
  drop_na(Plant)
november_survival_spatial <- right_join(measuring_survival_2, plots_topography, by = "plot_number") %>% 
  drop_na(Plant)
december_survival_spatial <- right_join(measuring_survival_3, plots_topography, by = "plot_number") %>% 
  drop_na(Plant)
```

## Make PCA for topographic data. 
  # use plots_topography data frame
  
```{r}
plots_topo_1 <-na.omit(st_set_geometry(plots_topography[,2:13],NULL))
plots_topo_2 <-plots_topo_1[,1:9]
plots_topo_3 <-plots_topo_1[,1:6]
plots_topo_4 <-plots_topo_1[,1:3]
plots_topo_5 <-plots_topo_1[,c(2,4:6)]

# PCA for all continuous variables
topo_pca_1 <-prcomp(plots_topo_1, scale=TRUE)
summary(topo_pca_1) # explains 67% variance in PC1+2
topo_pca1_var <- topo_pca_1$sdev^2/sum(topo_pca_1$sdev^2)
barplot(topo_pca1_var, main="Variance Explained", names.arg=c("PC1","PC2","PC3","PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11"))

# except terrain ruggedness/texture 
topo_pca_2 <-prcomp(plots_topo_2, scale=TRUE)
summary(topo_pca_2) # explains 73% variance in PC1+2
topo_pca2_var <- topo_pca_2$sdev^2/sum(topo_pca_2$sdev^2)
barplot(topo_pca2_var, main="Variance Explained", names.arg=c("PC1","PC2","PC3","PC4", "PC5", "PC6", "PC7", "PC8", "PC9"))
# elev, aspect, slope, 3 seasons radiation 
topo_pca_3 <-prcomp(plots_topo_3, scale=TRUE)
summary(topo_pca_3) # 82%

# elev, aspect, slope
topo_pca_4 <-prcomp(plots_topo_4, scale=TRUE)
summary(topo_pca_4) # 86%

# aspect, 3 seasons solar radiation
topo_pca_5 <-prcomp(plots_topo_5, scale=TRUE)
summary(topo_pca_5) # 96%

# bar chart of variance explained by each PC in PCR5
topo_pca5_var <- topo_pca_5$sdev^2/sum(topo_pca_5$sdev^2)
barplot(topo_pca5_var, main="Variance Explained", names.arg=c("PC1","PC2","PC3","PC4"))

#adding end survival to PCA
july_alive <- measuring_survival %>% 
  filter(alive == 1)
november_alive <- measuring_survival_2 %>% 
  filter(alive == 1)
december_alive <- measuring_survival_3 %>% 
  filter(alive == 1)
plot_survival <- watering_survival %>% 
  mutate(date_dead = case_when(alive == 0 ~ "may 2020",
                               !plot_number %in% july_alive$plot_number ~ "july 2020",
                               !plot_number %in% november_alive$plot_number ~ "november 2020",
                               !plot_number %in% december_alive$plot_number ~ "december 2021",
                               TRUE ~ "alive")) 

# adding species to PCA
plot_species_num <- na.omit(planting[,1:2]) %>% mutate(Plant = case_when(Plant == "ENCA (Pink)" ~ "ENCA",
                           Plant == "CEOL (Orange)" ~ "CEOL",
                           Plant == "HEWH (White)" ~ "HEWH",
                           Plant == "SAME (Orange + Pink)" ~ "SAME",
                           Plant == "SANI (Orange + Yellow)" ~ "SANI",
                           Plant == "RHOV (White + Pink)" ~ "RHOV",
                           Plant == "SAAP (White + Green)" ~ "SAAP",
                           Plant == "MALA (White + Yellow)" ~ "MALA",
                           Plant == "HEAR" ~ "HEAR",
                           Plant == "ADFA (Orange + Green)" ~ "ADFA",
                           Plant == "RHOV SAAP (White + Pink)" ~ "SAAP",
                           Plant == "ENCA CEOL (Pink)" ~ "CEOL", 
                           Plant == "HEWH (White) RHOV" ~ "RHOV",
                           Plant == "NO PLANT" ~ "No Plant"))

plot_species_name <- plot_species_num %>% mutate(Plant = case_when(Plant == "ADFA" ~ "Adenostoma fasciculatum",
                                   Plant == "CEOL" ~ "Ceanothus oliganthus",
                                   Plant == "ENCA" ~ "Encelia californica",
                                   Plant == "HEAR" ~ "Heteromeles arbutifolia",
                                   Plant == "HEWH" ~ "Hesperoyucca whipplei",
                                   Plant == "MALA" ~ "Malosma laurina",
                                   Plant == "RHOV" ~ "Rhus ovata",
                                   Plant == "SAAP" ~ "Salvia apiana",
                                   Plant == "SAME" ~ "Salvia mellifera", 
                                   Plant == "SANI" ~ "Sambucus nigra"))

# matching the number of rows to pass species data
plots_topography_noNA <- na.omit(plots_topography[,1:13])
plots_topography_named <- merge(x=plots_topography_noNA, y=plot_species_name, by="plot_number") %>% 
  merge(plot_survival, by = "plot_number")

#plot of pca1 colored by survival
may_dead <- plots_topography_named %>% 
  filter(date_dead == "may 2020")
autoplot(topo_pca_2, data = plots_topography_named, colour = "date_dead",
         loadings = TRUE, loadings.colour = 'grey', 
         loadings.label = FALSE, loadings.label.size = 3)

# plot of pca 3colored by species
autoplot(topo_pca_3, data = plots_topography_named, colour = "date_dead",
         loadings = TRUE, loadings.colour = 'grey', 
         loadings.label = FALSE, loadings.label.size = 3)

#plot of pca 4 colored by species
autoplot(topo_pca_4, data = plots_topography_named, colour = "date_dead",
         loadings = TRUE, loadings.colour = 'grey', 
         loadings.label = FALSE, loadings.label.size = 3)

# pca 5 colored by species. similar to pca 3
autoplot(topo_pca_5, data = plots_topography_named, colour = "date_dead",
         loadings = TRUE, loadings.colour = 'grey', 
         loadings.label = FALSE, loadings.label.size = 3)


```

```{r}
# Connecting PCA to plotted topo data, excl. gophers
pca_data <- as.data.frame(topo_pca_2[["x"]])

pca_data_all <- plots_topography_named %>% 
  mutate(pc1 = pca_data$PC1,
         pc2 = pca_data$PC2)

pca_data_no_gopher <- pca_data_all %>% 
  filter(plot_number %in% survival_gopher$plot_number)

ggplot(pca_data_no_gopher, aes(x = pc1, y = pc2, colour = Plant.x))+
  geom_point()+
  theme_classic() + 
  facet_wrap(~date_dead)
```


## Getting environmental data loaded in

```{r}
soil_moisture_1 <- read.csv(here("data", "soil_moisture_data", "piru landscape TDR data - 1_7.csv")) %>% dplyr::select(plot, m1, m2, m3, m4, date) %>% 
  group_by(plot) %>% 
  mutate(date = mdy("01-07-2020"),
         soil_moisture = mean(c(m1, m2, m3, m4), na.rm = TRUE)) %>% 
  ungroup() %>% 
  dplyr::select(plot, soil_moisture, date)

soil_moisture_2 <- read.csv(here("data", "soil_moisture_data", "piru landscape TDR data - 4_23.csv"))%>% dplyr::select(plot, m1, m2, m3, m4, date) %>% 
  group_by(plot) %>% 
  mutate(date = mdy("04-23-2020"),
         soil_moisture = mean(c(m1, m2, m3, m4), na.rm = TRUE)) %>%
  ungroup() %>% 
  
  dplyr::select(plot, soil_moisture, date)

soil_moisture_3 <- read.csv(here("data", "soil_moisture_data", "piru landscape TDR data - 5_21.csv"))%>% dplyr::select(plot, m1, m2, m3, m4, date) %>% 
  group_by(plot) %>% 
  mutate(date = mdy("05-21-2020"),
         soil_moisture = mean(c(m1, m2, m3, m4), na.rm = TRUE)) %>% 
  ungroup() %>% 
  dplyr::select(plot, soil_moisture, date)

# Moisture of 3 discreet timepoints
soil_moisture <- rbind(soil_moisture_1, soil_moisture_2) %>% 
  rbind(soil_moisture_3) %>% 
  rename(plot_number = plot)

moisture_logger_1 <- read.csv(here("data", "soil_moisture_data", "Data_loggers", "EM12384 22Oct20-1548.csv")) %>% 
  rename(date_time = Measurement.Time) %>% 
  rename("1132" = X1132) %>% 
  rename("1130" = X1130) %>% 
  rename("1124" = X1124) %>% 
  rename("1131" = X1131) %>% 
  rename("1647" = X1647) %>% 
  mutate(date_time = mdy_hm(date_time)) %>% 
  separate(date_time, into = c("date", "time"), sep = " ") %>% 
  pivot_longer(cols = c("1132", "1130", "1124", "1131", "1647"), names_to = "plot", values_to = "soil_moisture") %>% 
  mutate(date = ymd(date), 
         plot = as.numeric(plot), 
         soil_moisture = as.numeric(soil_moisture)) %>% 
  group_by(date, plot) %>% 
  summarise(soil_moisture = mean(soil_moisture)) %>% 
  na.omit()

moisture_logger_2 <- read.csv(here("data", "soil_moisture_data", "Data_loggers", "Hobo_Station_1_(1,2,3,14,15).csv")) %>% 
  rename("434" = "X434") %>% 
  rename("1546" = "X1546") %>% 
  rename("425" = "X425") %>% 
  rename("417" = "X417") %>% 
  rename("423" = "X423") %>% 
  pivot_longer(cols = c("434", "1546", "425", "417", "423"), names_to = "plot", values_to = "soil_moisture") %>% 
  mutate(date_time = mdy_hm(Date.Time..GMT.07.00)) %>% 
  separate(date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(date = ymd(date),
         plot = as.numeric(plot)) %>% 
  group_by(date, plot) %>% 
  summarise(soil_moisture = mean(soil_moisture))

moisture_logger_3 <- read.csv(here("data", "soil_moisture_data", "Data_loggers", "Hobo_Station_2_(12,13,4,5)_0.csv")) %>% 
  rename("155" = "X155") %>% 
  rename("166" = "X166") %>% 
  rename("190" = "X190") %>% 
  rename("92" = "X92") %>% 
  rename("203" = "X203") %>% 
  pivot_longer(cols = c("155", "166", "190", "92", "203"), names_to = "plot", values_to = "soil_moisture") %>% 
  mutate(date_time = mdy_hm(Date.Time..GMT.07.00)) %>% 
  separate(date_time, into = c("date", "time"), sep = " ") %>% 
  mutate(date = ymd(date),
         plot = as.numeric(plot)) %>% 
  group_by(date, plot) %>% 
  summarise(soil_moisture = mean(soil_moisture))

# Continuous moisture over time of 15 plots
moisture_loggers <- rbind(moisture_logger_1, moisture_logger_2) %>% 
  rbind(moisture_logger_3) %>% 
  na.omit() %>% 
  filter(soil_moisture >= 0) %>% 
  mutate(soil_moisture = soil_moisture*100)

ggplot(moisture_loggers, aes(x = date, y = soil_moisture, color = as.factor(plot)))+
  geom_point()

pca_soil_moisture <- pca_data_all %>% 
  filter(plot_number %in% soil_moisture$plot_number) %>% 
  right_join(soil_moisture, by = "plot_number")

# January soil moisture vs PC1 & PC2
pca_soil_moisture_jan <- pca_soil_moisture %>% 
  filter(date.y == "2020-01-07")
  
ggplot(pca_soil_moisture_jan, aes(x = pc1, y = soil_moisture)) +
  geom_point()

ggplot(pca_soil_moisture, aes(x = pc2, y = soil_moisture)) +
  geom_point() +
  facet_wrap(~date.y)

summary(lm(soil_moisture~pc1, data = pca_soil_moisture_jan))

# April soil moisture vs PC1 & PC2
pca_soil_moisture_april <- pca_soil_moisture %>% 
  filter(date.y == "2020-04-23")
  
ggplot(pca_soil_moisture_april, aes(x = pc1, y = soil_moisture)) +
  geom_point()

ggplot(pca_soil_moisture, aes(x = pc2, y = soil_moisture)) +
  geom_point() +
  facet_wrap(~date.y)

summary(lm(soil_moisture~pc1, data = pca_soil_moisture_april)) # R2=0.27

# May soil moisture vs PC1 & PC2
pca_soil_moisture_may <- pca_soil_moisture %>% 
  filter(date.y == "2020-05-21")
  
ggplot(pca_soil_moisture_may, aes(x = pc1, y = soil_moisture)) +
  geom_point()

ggplot(pca_soil_moisture, aes(x = pc2, y = soil_moisture)) +
  geom_point() +
  facet_wrap(~date.y)

summary(lm(soil_moisture~pc1, data = pca_soil_moisture_may)) # R2=0.24
```

```{r}
library(MASS)
pca_manova <- manova(cbind(pc1,pc2)~date_dead, data = pca_data_all)
dep <- cbind(pca_data_all$pc1, pca_data_all$pc2)
ind <- as.data.frame((pca_data_all$date_dead)) %>% 
  mutate(date_dead = as.factor(pca_data_all$date_dead)) %>% 
  dplyr::select(date_dead)
pca_lda <- lda(date_dead~pc1+pc2, data = pca_data_all, CV = F)
pca_lda

lda_df <- data.frame(
  date_dead = pca_data_all[,"date_dead"],
  lda = predict(pca_lda)$x
)
lda_df

ggplot(lda_df) +
  geom_point(aes(x = lda.LD1, y = lda.LD2, color = date_dead.date_dead))
```

## Next steps: 
 # See if PC1 and/or PC2 are correlated with soil moisture
 # read in temperature and do the same ^
 # average by month
 
```{r}

# Averages of soil moisture by month, grouped by plot no
moisture_loggers_May2020  <- moisture_loggers %>%
  filter(date>"2020/05/01", date<"2020/05/31") %>%
  group_by(plot) %>%
  summarise(avg_sm_May=mean(soil_moisture))
moisture_loggers_June2020 <- moisture_loggers %>%
  filter(date>"2020/06/01", date<"2020/06/30") %>%
  group_by(plot) %>%
  summarise(avg_sm_June=mean(soil_moisture))
moisture_loggers_July2020 <- moisture_loggers %>%
  filter(date>"2020/07/01", date<"2020/07/31") %>%
  group_by(plot) %>%
  summarise(avg_sm_July=mean(soil_moisture))
moisture_loggers_August2020 <- moisture_loggers %>%
  filter(date>"2020/08/01", date<"2020/08/31") %>%
  group_by(plot) %>%
  summarise(avg_sm_August=mean(soil_moisture))
moisture_loggers_September2020 <- moisture_loggers %>%
  filter(date>"2020/09/01", date<"2020/09/30") %>%
  group_by(plot) %>%
  summarise(avg_sm_September=mean(soil_moisture))
moisture_loggers_October2020 <- moisture_loggers %>%
  filter(date>"2020/10/01", date<"2020/10/31") %>%
  group_by(plot) %>%
  summarise(avg_sm_October=mean(soil_moisture))

# Moisture averages for each month added as columns to pca data
pca_moistlog_all <-pca_data_all %>% 
  filter(plot_number %in% moisture_loggers$plot) %>% 
  left_join(moisture_loggers_May2020, by = c("plot_number"="plot")) %>% 
  left_join(moisture_loggers_June2020, by = c("plot_number"="plot")) %>% 
  left_join(moisture_loggers_July2020, by = c("plot_number"="plot")) %>% 
  left_join(moisture_loggers_August2020, by = c("plot_number"="plot"))%>% 
  left_join(moisture_loggers_September2020, by = c("plot_number"="plot")) %>%
  left_join(moisture_loggers_October2020, by = c("plot_number"="plot"))

ggplot(pca_moistlog_all, aes(x = pc1, y = avg_sm_May)) +
  geom_point()

ggplot(pca_moistlog_all, aes(x = pc2, y = avg_sm_May)) +
  geom_point()

ggplot(pca_moistlog_all, aes(x = pc1, y = avg_sm_July)) +
  geom_point()

summary(lm(avg_sm_May~pc1+pc2, data = pca_moistlog_all)) #R2=0.55

summary(lm(avg_sm_July~pc1, data = pca_moistlog_all)) #R2=0.38



```

